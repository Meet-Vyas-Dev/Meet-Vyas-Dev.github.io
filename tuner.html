<!-- <html>
<head>
    <title>Meet Vyas</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,700" rel="stylesheet">
    <link rel="shortcut icon" type="image/png" href="pics/astronaut_favicon.png">
    <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/all.css">
    <link rel="stylesheet" href="css/jquery.timepicker.css">
    <link rel="stylesheet" href="css/owl.carousel.min.css">
    <link rel="stylesheet" href="css/owl.theme.default.min.css">
    <link rel="stylesheet" href="css/magnific-popup.css">
    <link rel="stylesheet" href="css/aos.css">
    <link rel="stylesheet" href="css/ionicons.min.css">
    <link rel="stylesheet" href="css/bootstrap-datepicker.css">
    <link rel="stylesheet" type="text/css" href="css/flaticon.css">
    <link rel="stylesheet" href="css/icomoon.css">
    <link rel="stylesheet" href="css/style.css">

    <script>// Define the set of test frequencies that we'll use to analyze microphone data.
        var C2 = 65.41; // C2 note, in Hz.
        var notes = [ "C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B" ];
        var test_frequencies = [];
        for (var i = 0; i < 30; i++)
        {
            var note_frequency = C2 * Math.pow(2, i / 12);
            var note_name = notes[i % 12];
            var note = { "frequency": note_frequency, "name": note_name };
            var just_above = { "frequency": note_frequency * Math.pow(2, 1 / 48), "name": note_name + " (a bit sharp)" };
            var just_below = { "frequency": note_frequency * Math.pow(2, -1 / 48), "name": note_name + " (a bit flat)" };
            test_frequencies = test_frequencies.concat([ just_below, note, just_above ]);
        }
        
        window.addEventListener("load", initialize);
        
        var correlation_worker = new Worker("js/correlation_worker.js");
        
        // Set up a message listener to receive messages from the worker
        correlation_worker.onmessage = function(e) {
            console.log('Message from worker:', e.data);
        };
        
        // Send a test message to the worker
        correlation_worker.postMessage('Test message');
        
        correlation_worker.addEventListener("message", interpret_correlation_result);
        
        function initialize()
        {
            var get_user_media = navigator.getUserMedia;
            get_user_media = get_user_media || navigator.webkitGetUserMedia;
            get_user_media = get_user_media || navigator.mozGetUserMedia;
            get_user_media.call(navigator, { "audio": true }, use_stream, function() {});
        
            document.getElementById("play-note").addEventListener("click", toggle_playing_note);
        }
        
        function use_stream(stream)
        {
            var audio_context = new AudioContext();
            var microphone = audio_context.createMediaStreamSource(stream);
            window.source = microphone; // Workaround for https://bugzilla.mozilla.org/show_bug.cgi?id=934512
            var script_processor = audio_context.createScriptProcessor(1024, 1, 1);
        
            script_processor.connect(audio_context.destination);
            microphone.connect(script_processor);
        
            var buffer = [];
            var sample_length_milliseconds = 100;
            var recording = true;
        
            // Need to leak this function into the global namespace so it doesn't get
            // prematurely garbage-collected.
            // http://lists.w3.org/Archives/Public/public-audio/2013JanMar/0304.html
            window.capture_audio = function(event)
            {
                if (!recording)
                    return;
        
                buffer = buffer.concat(Array.prototype.slice.call(event.inputBuffer.getChannelData(0)));
        
                // Stop recording after sample_length_milliseconds.
                if (buffer.length > sample_length_milliseconds * audio_context.sampleRate / 1000)
                {
                    recording = false;
        
                    correlation_worker.postMessage
                    (
                        {
                            "timeseries": buffer,
                            "test_frequencies": test_frequencies,
                            "sample_rate": audio_context.sampleRate
                        }
                    );
        
                    buffer = [];
                    setTimeout(function() { recording = true; }, 250);
                }
            };
        
            script_processor.onaudioprocess = window.capture_audio;
        }
        
        function interpret_correlation_result(event)
        {
            var timeseries = event.data.timeseries;
            var frequency_amplitudes = event.data.frequency_amplitudes;
        
            // Compute the (squared) magnitudes of the complex amplitudes for each
            // test frequency.
            var magnitudes = frequency_amplitudes.map(function(z) { return z[0] * z[0] + z[1] * z[1]; });
        
            // Find the maximum in the list of magnitudes.
            var maximum_index = -1;
            var maximum_magnitude = 0;
            for (var i = 0; i < magnitudes.length; i++)
            {
                if (magnitudes[i] <= maximum_magnitude)
                    continue;
        
                maximum_index = i;
                maximum_magnitude = magnitudes[i];
            }
        
            // Compute the average magnitude. We'll only pay attention to frequencies
            // with magnitudes significantly above average.
            var average = magnitudes.reduce(function(a, b) { return a + b; }, 0) / magnitudes.length;
            var confidence = maximum_magnitude / average;
            var confidence_threshold = 10; // empirical, arbitrary.
            if (confidence > confidence_threshold)
            {
                var dominant_frequency = test_frequencies[maximum_index];
                document.getElementById("note-name").textContent = dominant_frequency.name;
                document.getElementById("frequency").textContent = dominant_frequency.frequency;
            }
        }
        
        // Unnecessary addition of button to play an E note.
        var note_context = new AudioContext();
        var note_node = note_context.createOscillator();
        var gain_node = note_context.createGain();
        note_node.frequency = C2 * Math.pow(2, 4 / 12); // E, ~82.41 Hz.
        gain_node.gain.value = 0;
        note_node.connect(gain_node);
        gain_node.connect(note_context.destination);
        note_node.start();
        
        var playing = false;
        function toggle_playing_note()
        {
            playing = !playing;
            if (playing)
                gain_node.gain.value = 0.1;
            else
                gain_node.gain.value = 0;
        }
        </script>

<style>.tuner-container {
    text-align: center;
    background-color: rgba(0, 0, 0, 0.8);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
}

.tuner-display {
    position: relative;
    margin-bottom: 20px;
}

.dial-container {
    position: relative;
}

.dial {
    width: 200px;
    height: 100px;
    background: rgba(255, 255, 255, 0.1);
    border-top-left-radius: 100px;
    border-top-right-radius: 100px;
    position: relative;
    overflow: hidden;
}

.needle {
    width: 2px;
    height: 100%;
    background: red;
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: rotate(0deg);
    transform-origin: bottom;
}

.note-display {
    margin-top: -20px;
    font-size: 24px;
}

button {
    background-color: #333;
    color: #fff;
    border: none;
    padding: 10px 20px;
    font-size: 18px;
    cursor: pointer;
    border-radius: 5px;
}

button:hover {
    background-color: #555;
}
</style>


</head>
<body>
<div class="ftco-section">
    <div class="container">
        <div class="row justify-content-center mb-5 pb-5">
        <div class="note-display">
        <p>You are playing: </p>
        <h1 id="note-name"></h1>
        <p>
            <span>frequency (Hz):</span>
            <span id="frequency"></span>
        </p>
        </div>
        </div>
    </div>
</div>
</body>
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Meet Vyas</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,700" rel="stylesheet">
    <link rel="shortcut icon" type="image/png" href="pics/astronaut_favicon.png">
    <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/all.css">
    <link rel="stylesheet" href="css/jquery.timepicker.css">
    <link rel="stylesheet" href="css/owl.carousel.min.css">
    <link rel="stylesheet" href="css/owl.theme.default.min.css">
    <link rel="stylesheet" href="css/magnific-popup.css">
    <link rel="stylesheet" href="css/aos.css">
    <link rel="stylesheet" href="css/ionicons.min.css">
    <link rel="stylesheet" href="css/bootstrap-datepicker.css">
    <link rel="stylesheet" type="text/css" href="css/flaticon.css">
    <link rel="stylesheet" href="css/icomoon.css">
    <link rel="stylesheet" href="css/style.css">

    <!-- <style>
        .tuner-section {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 70vh;
            color: #fff;
        }

        .tuner-wrapper {
            width: 100%;
            max-width: 450px;
            background: rgba(18, 18, 18, 0.85);
            padding: 2rem 2.5rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin: 0 auto;
        }

        #activate-tuner {
            background-color: #ffd700;
            color: #121212;
            border: none;
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .button-container {
        display: flex;
        justify-content: center;
        margin-top: 1.5rem;
        align-items: center;
        }

        #activate-tuner:hover {
            background-color: #d0ff00;
            transform: scale(1.05);
        }
        
        .note-display {
            font-size: 8rem;
            font-weight: 700;
            line-height: 1;
            margin: 1rem 0;
            color: #ffffff;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            height: 120px; /* Reserve space to prevent layout shift */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .note-display sup {
            font-size: 3rem;
            margin-left: 0.2em;
            font-weight: 300;
            opacity: 0.8;
        }

        .pitch-indicator-bar {
            width: 100%;
            height: 10px;
            background: linear-gradient(90deg, #ff8c00, #202020, #202020, #ff8c00);
            border-radius: 5px;
            position: relative;
            margin: 1.5rem 0;
        }

        #pitch-dot {
            width: 18px;
            height: 18px;
            background: #ccc;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.2s ease-out;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .tuning-status {
            font-size: 1.5rem;
            font-weight: 500;
            height: 30px; /* Reserve space */
            transition: color 0.3s ease;
        }

        /* Status Colors */
        .status-tuned { color: #28a745; } /* Green */
        .status-sharp { color: #fd7e14; } /* Orange */
        .status-flat { color: #fd7e14; }  /* Orange */

        .dot-tuned { background: #28a745; box-shadow: 0 0 15px #28a745; }
        .dot-sharp { background: #fd7e14; box-shadow: 0 0 15px #fd7e14; }
        .dot-flat { background: #fd7e14; box-shadow: 0 0 15px #fd7e14; }
        .scroll-wrapper {
    max-height: 70vh; /* Adjust this value as needed */
    overflow-y: auto;
    padding-right: 15px; /* To prevent content from touching the scrollbar */
  }

  /* For WebKit browsers (Chrome, Safari) */
  .scroll-wrapper::-webkit-scrollbar {
    width: 8px;
  }

  .scroll-wrapper::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
  }

  .scroll-wrapper::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
  }

  /* For Firefox */
  .scroll-wrapper {
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.1);
  }

/* Mobile responsiveness */
@media (max-width: 768px) {
    .colorlib-navbar-brand {
        flex: 1;
    }
}   
    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @media (max-width: 768px) {
        .slider-item {
            height: 50vh;
        }
        .slider-text h1 {
            font-size: 24px;
        }
        .slider-text p a {
            font-size: 20px;
        }
    }
    </style> -->

    <style>
    .tuner-section {
        display: flex;
        align-items: flex-start; /* Align to top */
        justify-content: center;
        min-height: 80vh;
        color: #fff;
        padding-top: 3rem;
    }

    .tuner-wrapper {
        width: 100%;
        max-width: 600px;
        background: rgba(18, 18, 18, 0.9);
        padding: 2rem 2.5rem;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin: 0 auto;
    }

    /* Controls Styling */
    .controls-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .control-group {
        display: flex;
        flex-direction: column;
    }

    .control-group label {
        font-size: 0.9rem;
        color: #aaa;
        margin-bottom: 0.5rem;
        text-align: left;
    }

    .tuner-select {
        background-color: #333;
        color: #fff;
        border: 1px solid #555;
        border-radius: 5px;
        padding: 0.5rem;
        font-size: 1rem;
        width: 100%;
    }

    .a4-slider-group {
        grid-column: 1 / -1; /* Make slider span both columns */
    }

    #a4-slider {
        width: 100%;
    }

    /* String Display */
    .string-display-container {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2rem;
        min-height: 40px;
    }

    .string-indicator {
        font-size: 1.5rem;
        font-weight: bold;
        color: #777;
        transition: all 0.2s ease;
        padding: 0.2rem 0.5rem;
        cursor: pointer;
    }

    .string-indicator.highlighted {
        color: #ffd700; /* Yellow */
        transform: scale(1.2);
    }

    .string-indicator.tuned {
        color: #28a745; /* Green */
        text-shadow: 0 0 10px #28a745;
    }

    /* Tuner Display */
    #note-display {
        height: 120px;
        display: flex;
        align-items: baseline;
        justify-content: center;
    }

    #note-name {
        font-size: 8rem;
        line-height: 1;
        font-weight: 700;
    }

    #note-name sup {
        font-size: 3rem;
        font-weight: 300;
        opacity: 0.8;
        margin-left: 0.1em;
    }

    .pitch-indicator-bar {
        width: 100%;
        height: 10px;
        background: #333;
        border-radius: 5px;
        position: relative;
        margin: 1rem 0;
    }

    #pitch-dot {
        width: 20px;
        height: 20px;
        background: #ccc;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%; /* Start at center */
        transform: translate(-50%, -50%);
        transition: all 0.2s ease-out;
    }

    .tuning-status {
        font-size: 1.7rem;
        font-weight: 500;
        height: 35px; /* Reserve space */
        transition: color 0.3s ease;
    }
    
    .frequency-readout {
        color: #999;
        font-size: 1rem;
        height: 20px;
    }

    /* Status Colors */
    .status-tuned { color: #28a745; }
    .status-sharp, .status-flat { color: #fd7e14; }
    .dot-tuned { background: #28a745; box-shadow: 0 0 15px #28a745; }
    .dot-sharp, .dot-flat { background: #fd7e14; }

    /* Button Styling */
    .button-container { text-align: center; }

    #activate-tuner {
        background-color: #ffd700;
        color: #121212;
        border: none;
        padding: 12px 25px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        border-radius: 8px;
    }

    /* --- ✅ Mobile Responsiveness --- */
    @media (max-width: 768px) {
        .tuner-wrapper {
            padding: 1.5rem 1rem;
        }

        .controls-grid {
            grid-template-columns: 1fr; /* Stack controls vertically */
            gap: 1rem;
        }
        
        #note-display {
            height: 90px;
        }

        #note-name {
            font-size: 6rem; /* Reduce note size */
        }

        #note-name sup {
            font-size: 2rem; /* Reduce octave size */
        }

        .string-indicator {
            font-size: 1.2rem;
            padding: 0.2rem 0.3rem;
        }

        .tuning-status {
            font-size: 1.3rem;
        }
    }
    .scroll-wrapper {
    max-height: 70vh; /* Adjust this value as needed */
    overflow-y: auto;
    padding-right: 15px; /* To prevent content from touching the scrollbar */
  }

  /* For WebKit browsers (Chrome, Safari) */
  .scroll-wrapper::-webkit-scrollbar {
    width: 8px;
  }

  .scroll-wrapper::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
  }

  .scroll-wrapper::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
  }

  /* For Firefox */
  .scroll-wrapper {
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.1);
  }

/* Mobile responsiveness */
@media (max-width: 768px) {
    .colorlib-navbar-brand {
        flex: 1;
    }
}   
    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @media (max-width: 768px) {
        .slider-item {
            height: 50vh;
        }
        .slider-text h1 {
            font-size: 24px;
        }
        .slider-text p a {
            font-size: 20px;
        }
    }
</style>

</head>
<body>
    <div class="KW_progressContainer">
        <div class="KW_progressBar">
        </div>
    </div>
  
        <div class="page">
            <nav id="colorlib-main-nav" role="navigation">
                <a href="#" class="js-colorlib-nav-toggle colorlib-nav-toggle active"><i></i></a>
                <div class="js-fullheight colorlib-table">
                    <div class="img" style="background-image: url(pics/background.jpg);"></div>
                    <div class="colorlib-table-cell js-fullheight">
                        <div class="row no-gutters">
                            <div class="col-md-12 text-center">
                                <h1 class="mb-4"><a href="index.html" class="logo" style="color: #fff">Meet Vyas</a></h1>
                                <div class="scroll-wrapper">
                                    <ul>
                                        <li><a target="_self" href="index.html"><span><small>01</small>Home</span></a></li>
                                        <li><a target="_self" href="about.html"><span><small>02</small>About</span></a></li>
                                        <li><a target="_self" href="physics.html"><span><small>03</small>Physics</span></a></li>
                                        <li><a target="_self" href="comp.html"><span><small>04</small>Computer Science</span></a></li>
                                        <li><a target="_self" href="projects.html"><span><small>05</small>Course Projects</span></a></li>
                                        <li><a target="_self" href="blog.html"><span><small>06</small>Blog</span></a></li>                                
                                        <li><a target="_self" href="https://meet-vyas.notion.site/2096f14202de434995ea109d4381ca71?v=227db1b3a43446a98e2aaa79d7ff9461&pvs=4"><span><small>07</small>Reading List</span></a></li>
                                        <li><a target="_self" href="references.html"><span><small>08</small>References & Textbooks</span></a></li>     
                                        <li><a target="_self" href="tuner.html"><span><small>09</small>Tuner (Beta)</span></a></li>     
                                         
                                    </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>

        <div id="colorlib-page">
            <header>
                <div class="container">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="colorlib-navbar-brand">
                                <a class="colorlib-logo" href="index.html" style="color: #ffffff;"><span class="logo-img" style="background-image: url(pics/corner.jpg)"></span> Meet Vyas </a>
                            </div>
                            <a href="#" class="js-colorlib-nav-toggle colorlib-nav-toggle"><i></i></a>
                        </div>
                    </div>
                </div>
            </header>

    <section class="ftco-section tuner-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 text-center heading-section ftco-animate">
                <h2 style="font-size: 3em; color: #fff;">Instrument Tuner</h2>
                <p style="color: #ccc;">Select an instrument and tuning, then play a note.</p>
            </div>
        </div>
        <div class="row justify-content-center mt-4">
            <div class="col-md-10 ftco-animate">
                <div class="tuner-wrapper">

                    <div class="controls-grid">
                        <div class="control-group">
                            <label for="instrument-select">Instrument</label>
                            <select id="instrument-select" class="tuner-select"></select>
                        </div>
                        <div class="control-group">
                            <label for="tuning-select">Tuning</label>
                            <select id="tuning-select" class="tuner-select"></select>
                        </div>
                        <div class="control-group a4-slider-group">
                            <label for="a4-slider">Reference: <span id="a4-freq-display">440</span> Hz</label>
                            <input type="range" id="a4-slider" min="430" max="450" value="440" step="1">
                        </div>
                    </div>

                    <div id="string-display" class="string-display-container">
                        </div>

                    <div id="tuner-interface" style="display: none;">
                        <div id="note-display">
                            <span id="note-name">--</span>
                            <sup id="octave"></sup>
                        </div>
                        <div class="pitch-indicator-bar">
                            <div id="pitch-dot"></div>
                        </div>
                        <div id="tuning-status" class="tuning-status">Awaiting Input</div>
                        <div id="frequency-display" class="frequency-readout">-- Hz</div>
                    </div>

                    <div id="activation-prompt" class="button-container">
                        <button id="activate-tuner">Activate Tuner</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</section>

            <footer class="ftco-footer ftco-bg-dark ftco-section">
                <div class="container">
                  <div class="row mb-5 justify-content-center">
                    <div class="col-md-5 text-center">
                      <div class="ftco-footer-widget mb-5">
                        <ul class="ftco-footer-social list-unstyled">
                           <li class="ftco-animate"><a href="https://www.linkedin.com/in/meet--vyas/" style="color: #ffd700" target="_self"><span class="fa-brands fa-linkedin"></span></a></li>
                           <li class="ftco-animate"><a href="https://www.instagram.com/the_souled_guitarist/" style="color: #ffd700" target="_self"><span class="fa-brands fa-instagram"></span></a></li>
                           <li class="ftco-animate"><a href="https://twitter.com/meet_cosmo" style="color: #ffd700" target="_self"><span class="fa-brands fa-twitter"></span></a></li>
                           <li class="ftco-animate"><a href="https://github.com/Meet-Vyas-Dev" style="color: #ffd700" target="_self"><span class="fa-brands fa-github"></span></a></li>
                           <!-- <li class="ftco-animate"><a href="https://letterboxd.com/meetwee/" style="color: #ffd700" target="_self"><span class="fa-brands fa-letterboxd"></span></a></li> -->
                        </ul>     
                      </div>
                      <div class="ftco-footer-widget">
                        <h2 class="mb-3">Contact Me</h2>
                        <p class="h3 email"><a href="mailto:meet.v2@ahduni.edu.in">meet.v2 [at] ahduni.edu.in</a></p>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-12 text-center">
        
                      <p><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
              Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved
              <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. --></p>
                    </div>
                  </div>
                </div>
              </footer>
        </div>
    </div>

    <div id="ftco-loader" class="show fullscreen"><svg class="circular" width="48px" height="48px">
            <circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke="#eeeeee" />
            <circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke-miterlimit="10" stroke="#F96D00" /></svg></div>

    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-migrate-3.0.1.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.easing.1.3.js"></script>
    <script src="js/jquery.waypoints.min.js"></script>
    <script src="js/jquery.stellar.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/jquery.magnific-popup.min.js"></script>
    <!-- <script src="js/aos.js"></script> -->
    <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
    <script src="js/jquery.animateNumber.min.js"></script>
    <script src="js/scrollax.min.js"></script>
    <script src="js/bootstrap-datepicker.js"></script>
    <script src="js/jquery.timepicker.min.js"></script>
    <!-- <script src="js/google-map.js"></script> -->
    <script src="js/main.js"></script>
    <script src="https://kit.fontawesome.com/a95309870d.js" crossorigin="anonymous"></script>
    <script src="js/tuner-processor.js"></script>

    <!-- <script>
        // --- DOM Elements ---
        const activateButton = document.getElementById('activate-tuner');
        const tunerInterface = document.getElementById('tuner-interface');
        const noteNameEl = document.getElementById('note-name');
        const octaveEl = document.getElementById('octave');
        const tuningStatusEl = document.getElementById('tuning-status');
        const pitchDotEl = document.getElementById('pitch-dot');

        // --- Tuner Configuration ---
        const C2 = 65.41; // C2 note in Hz
        const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const test_frequencies = [];

        for (let i = 0; i < 48; i++) { // Increased range to cover more octaves
            const note_frequency = C2 * Math.pow(2, i / 12);
            const note_name = notes[i % 12];
            const octave = 2 + Math.floor(i / 12);

            // We define a finer resolution for sharp/flat detection
            const cents_deviation = 5; // How many cents for sharp/flat
            const ratio = Math.pow(2, cents_deviation / 1200);

            const note = { "frequency": note_frequency, "name": note_name, "octave": octave, "clarity": "In Tune" };
            const sharp = { "frequency": note_frequency * ratio, "name": note_name, "octave": octave, "clarity": "Sharp" };
            const flat = { "frequency": note_frequency / ratio, "name": note_name, "octave": octave, "clarity": "Flat" };

            test_frequencies.push(flat, note, sharp);
        }

        // --- Web Worker ---
        let correlation_worker;
        try {
            correlation_worker = new Worker("js/correlation_worker.js");
            correlation_worker.addEventListener("message", interpret_correlation_result);
        } catch (e) {
            console.error("Failed to create worker. Ensure correlation_worker.js exists.", e);
            alert("Tuner could not be initialized. A required file might be missing.");
        }
        

        // --- Audio Processing ---
        let audio_context;
        let recording = false;

        function startTuner() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Your browser does not support microphone access.');
                return;
            }

            navigator.mediaDevices.getUserMedia({ "audio": true })
                .then(use_stream)
                .catch(err => {
                    console.error("Error accessing microphone:", err);
                    alert("Could not access the microphone. Please grant permission.");
                });
        }

        function use_stream(stream) {
            activateButton.style.display = 'none';
            tunerInterface.style.display = 'block';

            audio_context = new (window.AudioContext || window.webkitAudioContext)();
            const microphone = audio_context.createMediaStreamSource(stream);
            const script_processor = audio_context.createScriptProcessor(2048, 1, 1);

            script_processor.connect(audio_context.destination);
            microphone.connect(script_processor);

            let buffer = [];
            const sample_length_milliseconds = 100; // Sample audio for this duration
            recording = true;

            script_processor.onaudioprocess = function(event) {
                if (!recording) return;

                buffer = buffer.concat(Array.prototype.slice.call(event.inputBuffer.getChannelData(0)));

                if (buffer.length > sample_length_milliseconds * audio_context.sampleRate / 1000) {
                    recording = false;

                    if (correlation_worker) {
                        correlation_worker.postMessage({
                            "timeseries": buffer,
                            "test_frequencies": test_frequencies.map(f => f.frequency),
                            "sample_rate": audio_context.sampleRate
                        });
                    }
                    
                    buffer = [];
                    setTimeout(() => { recording = true; }, 200); // Wait before next sample
                }
            };
        }

        function interpret_correlation_result(event) {
            const frequency_amplitudes = event.data.frequency_amplitudes;
            if (!frequency_amplitudes) return;

            const magnitudes = frequency_amplitudes.map(z => z[0] * z[0] + z[1] * z[1]);
            
            let maximum_index = -1;
            let maximum_magnitude = 0;
            for (let i = 0; i < magnitudes.length; i++) {
                if (magnitudes[i] > maximum_magnitude) {
                    maximum_magnitude = magnitudes[i];
                    maximum_index = i;
                }
            }
            
            const average = magnitudes.reduce((a, b) => a + b, 0) / magnitudes.length;
            const confidence = maximum_magnitude / average;
            const confidence_threshold = 20; // Needs significant peak to register

            if (confidence > confidence_threshold) {
                const dominant_note = test_frequencies[maximum_index];
                update_ui(dominant_note);
            } else {
                 // Optionally reset UI if confidence is low
                 // update_ui({ name: '--', octave: '', clarity: 'Awaiting Input' });
            }
        }
        
        function update_ui(note) {
            noteNameEl.textContent = note.name;
            octaveEl.textContent = note.octave;
            tuningStatusEl.textContent = note.clarity;

            // Reset classes
            tuningStatusEl.className = 'tuning-status';
            pitchDotEl.className = '';

            let position = '0%'; // Center for 'In Tune'
            
            if (note.clarity === 'Sharp') {
                position = '40%';
                tuningStatusEl.classList.add('status-sharp');
                pitchDotEl.classList.add('dot-sharp');
            } else if (note.clarity === 'Flat') {
                position = '-40%';
                tuningStatusEl.classList.add('status-flat');
                pitchDotEl.classList.add('dot-flat');
            } else if (note.clarity === 'In Tune') {
                tuningStatusEl.classList.add('status-tuned');
                pitchDotEl.classList.add('dot-tuned');
            }
            
            pitchDotEl.style.transform = `translate(-50%, -50%) translateX(${position})`;
        }

        // --- Event Listeners ---
        activateButton.addEventListener('click', startTuner);

    </script> -->

    <!-- <script>
    // --- DOM Elements ---
    const activateButton = document.getElementById('activate-tuner');
    const tunerInterface = document.getElementById('tuner-interface');
    const noteNameEl = document.getElementById('note-name');
    const octaveEl = document.getElementById('octave');
    const tuningStatusEl = document.getElementById('tuning-status');
    const pitchDotEl = document.getElementById('pitch-dot');

    // --- Tuner Configuration ---
    const A4 = 440;
    const notes = ["A", "A#", "B", "C", "C#", "D", "D#", "E", "F", "F#", "G", "G#"];
    let audioContext;
    let correlationWorker;

    // --- Core Functions ---
    async function setupAudio() {
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // Load the AudioWorklet processor
            await audioContext.audioWorklet.addModule('js/tuner-processor.js');
            const tunerNode = new AudioWorkletNode(audioContext, 'tuner-processor');
            
            // Connect the microphone to the worklet
            const microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(tunerNode);
            
            // Set up the pitch detection worker
            correlationWorker = new Worker("js/correlation_worker.js");

            // Listen for messages from the AudioWorklet (containing audio data)
            tunerNode.port.onmessage = (event) => {
                correlationWorker.postMessage({
                    audioBuffer: event.data,
                    sampleRate: audioContext.sampleRate,
                });
            };
            
            // Listen for messages from the pitch detection worker (containing frequency)
            correlationWorker.onmessage = (event) => {
                const { frequency } = event.data;
                if (frequency !== -1) {
                    processFrequency(frequency);
                }
            };
            
            return true; // Success
        } catch (err) {
            console.error("Failed to initialize audio:", err);
            alert("Could not access the microphone. Please grant permission and refresh the page.");
            return false;
        }
    }

    function processFrequency(freq) {
        // Calculate how many half-steps away from A4 the frequency is
        const halfStepsFromA4 = 12 * Math.log2(freq / A4);
        const noteIndex = Math.round(halfStepsFromA4);
        
        // Get the closest note's properties
        const closestNoteName = notes[(noteIndex % 12 + 12) % 12];
        const closestOctave = 4 + Math.floor((noteIndex + 9) / 12);
        const closestNoteFreq = A4 * Math.pow(2, noteIndex / 12);

        // Calculate the deviation in cents
        const centsDeviation = 1200 * Math.log2(freq / closestNoteFreq);

        updateUI(closestNoteName, closestOctave, centsDeviation);
    }

    function updateUI(noteName, octave, cents) {
        noteNameEl.textContent = noteName;
        octaveEl.textContent = octave;

        // Reset classes
        tuningStatusEl.className = 'tuning-status';
        pitchDotEl.className = '';

        // Determine tuning status and update UI
        if (Math.abs(cents) < 10) { // In tune range
            tuningStatusEl.textContent = 'In Tune';
            tuningStatusEl.classList.add('status-tuned');
            pitchDotEl.classList.add('dot-tuned');
        } else if (cents > 0) {
            tuningStatusEl.textContent = `Sharp (+${cents.toFixed(0)})`;
            tuningStatusEl.classList.add('status-sharp');
            pitchDotEl.classList.add('dot-sharp');
        } else {
            tuningStatusEl.textContent = `Flat (${cents.toFixed(0)})`;
            tuningStatusEl.classList.add('status-flat');
            pitchDotEl.classList.add('dot-flat');
        }

        // Position the dot based on cents deviation. Clamp between -50 and 50.
        const clampedCents = Math.max(-50, Math.min(50, cents));
        const position = `${clampedCents}%`; // Position directly corresponds to cents
        pitchDotEl.style.transform = `translate(-50%, -50%) translateX(${position})`;
    }

    // --- Event Listener ---
    activateButton.addEventListener('click', async () => {
        // Resume AudioContext on user interaction
        if (!audioContext) {
            const success = await setupAudio();
            if (success) {
                 activateButton.style.display = 'none';
                 tunerInterface.style.display = 'block';
            }
        } else if (audioContext.state === 'suspended') {
            audioContext.resume();
        }
    });
</script> -->

<!-- <script>
    // --- DOM Elements ---
    const activateButton = document.getElementById('activate-tuner');
    const activationPrompt = document.getElementById('activation-prompt');
    const tunerInterface = document.getElementById('tuner-interface');
    const noteNameEl = document.getElementById('note-name');
    const tuningStatusEl = document.getElementById('tuning-status');
    const pitchDotEl = document.getElementById('pitch-dot');
    const freqDisplayEl = document.getElementById('frequency-display');
    const stringDisplayContainer = document.getElementById('string-display');
    const instrumentSelect = document.getElementById('instrument-select');
    const tuningSelect = document.getElementById('tuning-select');
    const a4Slider = document.getElementById('a4-slider');
    const a4Display = document.getElementById('a4-freq-display');

    // --- Tuner Configuration & Data ---
    let A4 = 440;
    const notes = ["A", "A#", "B", "C", "C#", "D", "D#", "E", "F", "F#", "G", "G#"];
    let audioContext;
    let correlationWorker;

    const TUNINGS = {
        guitar: {
            name: 'Guitar',
            tunings: {
                standard: { name: 'Standard', notes: [{ n: 'E', o: 4 }, { n: 'B', o: 3 }, { n: 'G', o: 3 }, { n: 'D', o: 3 }, { n: 'A', o: 2 }, { n: 'E', o: 2 }] },
                dropD: { name: 'Drop D', notes: [{ n: 'E', o: 4 }, { n: 'B', o: 3 }, { n: 'G', o: 3 }, { n: 'D', o: 3 }, { n: 'A', o: 2 }, { n: 'D', o: 2 }] },
                dropC: { name: 'Drop C', notes: [{ n: 'D', o: 4 }, { n: 'A', o: 3 }, { n: 'F', o: 3 }, { n: 'C', o: 3 }, { n: 'G', o: 2 }, { n: 'C', o: 2 }] },
                openG: { name: 'Open G', notes: [{ n: 'D', o: 4 }, { n: 'B', o: 3 }, { n: 'G', o: 3 }, { n: 'D', o: 3 }, { n: 'G', o: 2 }, { n: 'D', o: 2 }] }
            }
        },
        bass: {
            name: 'Bass (4-String)',
            tunings: {
                standard: { name: 'Standard', notes: [{ n: 'G', o: 2 }, { n: 'D', o: 2 }, { n: 'A', o: 1 }, { n: 'E', o: 1 }] }
            }
        },
        ukulele: {
            name: 'Ukulele',
            tunings: {
                standard: { name: 'Standard (GCEA)', notes: [{ n: 'A', o: 4 }, { n: 'E', o: 4 }, { n: 'C', o: 4 }, { n: 'G', o: 4 }] }
            }
        }
    };

    // --- Core Audio & Processing Logic ---
    async function setupAudio() {
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            await audioContext.audioWorklet.addModule('js/tuner-processor.js');
            const tunerNode = new AudioWorkletNode(audioContext, 'tuner-processor');
            const microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(tunerNode);
            correlationWorker = new Worker("js/correlation_worker.js");
            tunerNode.port.onmessage = (event) => correlationWorker.postMessage({ audioBuffer: event.data, sampleRate: audioContext.sampleRate });
            correlationWorker.onmessage = (event) => processFrequency(event.data.frequency);
            return true;
        } catch (err) {
            console.error("Failed to initialize audio:", err);
            alert("Could not access the microphone. Please grant permission.");
            return false;
        }
    }

    function getNoteFrequency(noteName, octave) {
        const noteIndex = notes.indexOf(noteName);
        const halfStepsFromA4 = noteIndex - notes.indexOf('A') + (octave - 4) * 12;
        return A4 * Math.pow(2, halfStepsFromA4 / 12);
    }

    function processFrequency(freq) {
        if (freq === -1) {
             updateUI({cents: 0, detectedNote: '--', detectedOctave: '', closestStringIndex: -1});
             freqDisplayEl.textContent = '-- Hz';
             return;
        }

        const currentTuningKey = tuningSelect.value;
        const currentInstrumentKey = instrumentSelect.value;
        const currentTuning = TUNINGS[currentInstrumentKey].tunings[currentTuningKey].notes;
        
        let closestStringIndex = -1;
        let smallestCentsDiff = Infinity;

        currentTuning.forEach((stringNote, index) => {
            const targetFreq = getNoteFrequency(stringNote.n, stringNote.o);
            const centsDiff = 1200 * Math.log2(freq / targetFreq);
            if (Math.abs(centsDiff) < Math.abs(smallestCentsDiff)) {
                smallestCentsDiff = centsDiff;
                closestStringIndex = index;
            }
        });

        const halfStepsFromA4 = Math.round(12 * Math.log2(freq / A4));
        const detectedNote = notes[(halfStepsFromA4 % 12 + 12) % 12];
        const detectedOctave = 4 + Math.floor(halfStepsFromA4 / 12);
        
        updateUI({
            cents: smallestCentsDiff,
            detectedNote,
            detectedOctave,
            closestStringIndex
        });
        freqDisplayEl.textContent = `${freq.toFixed(2)} Hz`;
    }
    
    // --- UI Update Functions ---
    function updateUI({ cents, detectedNote, detectedOctave, closestStringIndex }) {
        noteNameEl.innerHTML = `${detectedNote}<sup>${detectedOctave}</sup>`;
        
        // Update string indicators
        document.querySelectorAll('.string-indicator').forEach((el, i) => {
            el.classList.remove('highlighted', 'tuned');
            if (i === closestStringIndex) {
                el.classList.add('highlighted');
                if (Math.abs(cents) < 8) { // Threshold for "tuned" highlight
                    el.classList.add('tuned');
                }
            }
        });

        // Update status text and pitch dot
        tuningStatusEl.className = 'tuning-status';
        pitchDotEl.className = '';

        if (Math.abs(cents) < 8) {
            tuningStatusEl.textContent = `In Tune (${cents.toFixed(1)} cents)`;
            tuningStatusEl.classList.add('status-tuned');
            pitchDotEl.classList.add('dot-tuned');
        } else if (cents > 0) {
            tuningStatusEl.textContent = `Sharp (+${cents.toFixed(1)} cents)`;
            tuningStatusEl.classList.add('status-sharp');
            pitchDotEl.classList.add('dot-sharp');
        } else {
            tuningStatusEl.textContent = `Flat (${cents.toFixed(1)} cents)`;
            tuningStatusEl.classList.add('status-flat');
            pitchDotEl.classList.add('dot-flat');
        }
        
        const clampedCents = Math.max(-50, Math.min(50, cents));
        pitchDotEl.style.transform = `translate(-50%, -50%) translateX(${clampedCents * 2}%)`; // Multiply by 2 for more visible movement
    }
    
    function populateInstrumentSelect() {
        for (const key in TUNINGS) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = TUNINGS[key].name;
            instrumentSelect.appendChild(option);
        }
    }

    function updateTuningOptions() {
        const instrumentKey = instrumentSelect.value;
        tuningSelect.innerHTML = '';
        const tunings = TUNINGS[instrumentKey].tunings;
        for (const key in tunings) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = tunings[key].name;
            tuningSelect.appendChild(option);
        }
        updateStringDisplay();
    }
    
    function updateStringDisplay() {
        const instrumentKey = instrumentSelect.value;
        const tuningKey = tuningSelect.value;
        const tuning = TUNINGS[instrumentKey].tunings[tuningKey];
        stringDisplayContainer.innerHTML = '';
        tuning.notes.forEach(note => {
            const span = document.createElement('span');
            span.className = 'string-indicator';
            span.textContent = note.n;
            stringDisplayContainer.appendChild(span);
        });
    }

    // --- Initial Setup & Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        populateInstrumentSelect();
        updateTuningOptions();

        instrumentSelect.addEventListener('change', updateTuningOptions);
        tuningSelect.addEventListener('change', updateStringDisplay);
        
        a4Slider.addEventListener('input', (e) => {
            A4 = parseInt(e.target.value);
            a4Display.textContent = A4;
        });

        activateButton.addEventListener('click', async () => {
            if (!audioContext) {
                if (await setupAudio()) {
                    activationPrompt.style.display = 'none';
                    tunerInterface.style.display = 'block';
                }
            } else if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        });
    });
</script> -->

<script>
    // --- DOM Elements ---
    const activateButton = document.getElementById('activate-tuner');
    const activationPrompt = document.getElementById('activation-prompt');
    const tunerInterface = document.getElementById('tuner-interface');
    const noteNameEl = document.getElementById('note-name');
    const tuningStatusEl = document.getElementById('tuning-status');
    const pitchDotEl = document.getElementById('pitch-dot');
    const freqDisplayEl = document.getElementById('frequency-display');
    const stringDisplayContainer = document.getElementById('string-display');
    const instrumentSelect = document.getElementById('instrument-select');
    const tuningSelect = document.getElementById('tuning-select');
    const a4Slider = document.getElementById('a4-slider');
    const a4Display = document.getElementById('a4-freq-display');

    // --- Tuner Configuration & Data ---
    let A4 = 440;
    const notes = ["A", "A#", "B", "C", "C#", "D", "D#", "E", "F", "F#", "G", "G#"];
    let audioContext;
    let correlationWorker;

    const TUNINGS = {
        guitar: {
            name: 'Guitar',
            tunings: {
                standard: { name: 'Standard', notes: [{ n: 'E', o: 2 }, { n: 'A', o: 2 }, { n: 'D', o: 3 }, { n: 'G', o: 3 }, { n: 'B', o: 3 }, { n: 'E', o: 4 }] },
                dropD: { name: 'Drop D', notes: [{ n: 'D', o: 2 }, { n: 'A', o: 2 }, { n: 'D', o: 3 }, { n: 'G', o: 3 }, { n: 'B', o: 3 }, { n: 'E', o: 4 }] },
                dropC: { name: 'Drop C', notes: [{ n: 'C', o: 2 }, { n: 'G', o: 2 }, { n: 'C', o: 3 }, { n: 'F', o: 3 }, { n: 'A', o: 3 }, { n: 'D', o: 4 }] },
                openG: { name: 'Open G', notes: [{ n: 'D', o: 2 }, { n: 'G', o: 2 }, { n: 'D', o: 3 }, { n: 'G', o: 3 }, { n: 'B', o: 3 }, { n: 'D', o: 4 }] }
            }
        },
        bass: {
            name: 'Bass (4-String)',
            tunings: {
                standard: { name: 'Standard', notes: [{ n: 'E', o: 1 }, { n: 'A', o: 1 }, { n: 'D', o: 2 }, { n: 'G', o: 2 }] }
            }
        },
        ukulele: {
            name: 'Ukulele',
            tunings: {
                standard: { name: 'Standard (GCEA)', notes: [{ n: 'G', o: 4 }, { n: 'C', o: 4 }, { n: 'E', o: 4 }, { n: 'A', o: 4 }] }
            }
        }
    };

    // --- ✅ NEW: Function to Play Reference Tone ---
    function playNote(noteName, octave) {
        if (!audioContext) {
            alert('Please activate the tuner first to enable the audio context.');
            return;
        }

        const frequency = getNoteFrequency(noteName, octave);
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        // Connect nodes: Oscillator -> Gain -> Destination (speakers)
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        // Configure the tone
        oscillator.type = 'sine'; // A pure tone is best for reference
        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

        // Configure volume with a smooth fade-in and fade-out to prevent clicking
        const now = audioContext.currentTime;
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(0.3, now + 0.05); // Fade in to 30% volume
        gainNode.gain.linearRampToValueAtTime(0, now + 1.0); // Fade out over 1 second

        // Start and stop the oscillator
        oscillator.start(now);
        oscillator.stop(now + 1.0);
    }

    // --- Core Audio & Processing Logic ---
    async function setupAudio() {
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            await audioContext.audioWorklet.addModule('js/tuner-processor.js');
            const tunerNode = new AudioWorkletNode(audioContext, 'tuner-processor');
            const microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(tunerNode);
            correlationWorker = new Worker("js/correlation_worker.js");
            tunerNode.port.onmessage = (event) => correlationWorker.postMessage({ audioBuffer: event.data, sampleRate: audioContext.sampleRate });
            correlationWorker.onmessage = (event) => processFrequency(event.data.frequency);
            return true;
        } catch (err) {
            console.error("Failed to initialize audio:", err);
            alert("Could not access the microphone. Please grant permission.");
            return false;
        }
    }

    function getNoteFrequency(noteName, octave) {
        const noteIndex = notes.indexOf(noteName);
        const halfStepsFromA4 = noteIndex - notes.indexOf('A') + (octave - 4) * 12;
        return A4 * Math.pow(2, halfStepsFromA4 / 12);
    }

    function processFrequency(freq) {
        if (freq === -1) {
             updateUI({cents: 0, detectedNote: '--', detectedOctave: '', closestStringIndex: -1});
             freqDisplayEl.textContent = '-- Hz';
             return;
        }

        const currentTuningKey = tuningSelect.value;
        const currentInstrumentKey = instrumentSelect.value;
        const currentTuning = TUNINGS[currentInstrumentKey].tunings[currentTuningKey].notes;
        
        let closestStringIndex = -1;
        let smallestCentsDiff = Infinity;

        currentTuning.forEach((stringNote, index) => {
            const targetFreq = getNoteFrequency(stringNote.n, stringNote.o);
            const centsDiff = 1200 * Math.log2(freq / targetFreq);
            if (Math.abs(centsDiff) < Math.abs(smallestCentsDiff)) {
                smallestCentsDiff = centsDiff;
                closestStringIndex = index;
            }
        });

        const halfStepsFromA4 = Math.round(12 * Math.log2(freq / A4));
        const detectedNote = notes[(halfStepsFromA4 % 12 + 12) % 12];
        const detectedOctave = 4 + Math.floor(halfStepsFromA4 / 12);
        
        updateUI({
            cents: smallestCentsDiff,
            detectedNote,
            detectedOctave,
            closestStringIndex
        });
        freqDisplayEl.textContent = `${freq.toFixed(2)} Hz`;
    }
    
    // --- UI Update Functions ---
    function updateUI({ cents, detectedNote, detectedOctave, closestStringIndex }) {
        noteNameEl.innerHTML = `${detectedNote}<sup>${detectedOctave}</sup>`;
        
        document.querySelectorAll('.string-indicator').forEach((el, i) => {
            el.classList.remove('highlighted', 'tuned');
            if (i === closestStringIndex) {
                el.classList.add('highlighted');
                if (Math.abs(cents) < 8) {
                    el.classList.add('tuned');
                }
            }
        });

        tuningStatusEl.className = 'tuning-status';
        pitchDotEl.className = '';

        if (Math.abs(cents) < 8) {
            tuningStatusEl.textContent = `In Tune (${cents.toFixed(1)} cents)`;
            tuningStatusEl.classList.add('status-tuned');
            pitchDotEl.classList.add('dot-tuned');
        } else if (cents > 0) {
            tuningStatusEl.textContent = `Sharp (+${cents.toFixed(1)} cents)`;
            tuningStatusEl.classList.add('status-sharp');
            pitchDotEl.classList.add('dot-sharp');
        } else {
            tuningStatusEl.textContent = `Flat (${cents.toFixed(1)} cents)`;
            tuningStatusEl.classList.add('status-flat');
            pitchDotEl.classList.add('dot-flat');
        }
        
        const clampedCents = Math.max(-50, Math.min(50, cents));
        pitchDotEl.style.transform = `translate(-50%, -50%) translateX(${clampedCents * 2}%)`;
    }
    
    function populateInstrumentSelect() {
        for (const key in TUNINGS) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = TUNINGS[key].name;
            instrumentSelect.appendChild(option);
        }
    }

    function updateTuningOptions() {
        const instrumentKey = instrumentSelect.value;
        tuningSelect.innerHTML = '';
        const tunings = TUNINGS[instrumentKey].tunings;
        for (const key in tunings) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = tunings[key].name;
            tuningSelect.appendChild(option);
        }
        updateStringDisplay();
    }
    
    // --- ✅ MODIFIED: Make String Indicators Clickable ---
    function updateStringDisplay() {
        const instrumentKey = instrumentSelect.value;
        const tuningKey = tuningSelect.value;
        const tuning = TUNINGS[instrumentKey].tunings[tuningKey];
        stringDisplayContainer.innerHTML = '';
        tuning.notes.forEach(note => {
            const span = document.createElement('span');
            span.className = 'string-indicator';
            span.textContent = note.n;
            
            // Add data attributes to store note info
            span.dataset.note = note.n;
            span.dataset.octave = note.o;

            // Add the click event listener to play the note
            span.addEventListener('click', (e) => {
                const noteName = e.target.dataset.note;
                const octave = parseInt(e.target.dataset.octave);
                playNote(noteName, octave);
            });

            stringDisplayContainer.appendChild(span);
        });
    }

    // --- Initial Setup & Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        populateInstrumentSelect();
        updateTuningOptions();

        instrumentSelect.addEventListener('change', updateTuningOptions);
        tuningSelect.addEventListener('change', updateStringDisplay);
        
        a4Slider.addEventListener('input', (e) => {
            A4 = parseInt(e.target.value);
            a4Display.textContent = A4;
        });

        activateButton.addEventListener('click', async () => {
            if (!audioContext) {
                if (await setupAudio()) {
                    activationPrompt.style.display = 'none';
                    tunerInterface.style.display = 'block';
                }
            } else if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        });
    });
</script>

</body>
</html>